#!/bin/bash

set -e

AdminTokenHash=$1
HttpsPort=$2

# Define test directory
TEST_DIR="pccsadmin_test"
mkdir -p "$TEST_DIR"
cd "$TEST_DIR"

# Cleanup on exit (success or failure)
cleanup() {
    cd ..
    rm -rf "$TEST_DIR"
}
trap cleanup EXIT

# Start tests
PCKIDRetrievalTool
pccsadmin collect
# Check if platform_collaterals.json was generated
if [ ! -f platform_collaterals.json ]; then
    echo "Pccsadmin collect failed, platform_collaterals.json was not generated."
    exit 1
fi

# pccsadmin fetch
expect -c "
set timeout 240
spawn pccsadmin fetch
expect {
    -re \"ApiKey.*:\" {
        send \"\$env(PCCS_PRIMARY_API_KEY)\r\"
        exp_continue
    }
    -re \"remember.*y/n\" {
        send \"n\r\"
        exp_continue
    }
    eof { exit 0 }
    timeout { puts \"Error: Pattern not found\"; exit 1 }
}
"
# Check if platform_collaterals.json was generated
if [ ! -f platform_collaterals.json ]; then
    echo "Pccsadmin fetch failed, platform_collaterals.json was not generated."
    exit 1
fi

# pccsadmin put
URL="https://localhost:$HttpsPort/sgx/certification/v4/platformcollateral"
expect -c "
set timeout 240
spawn pccsadmin put -u $URL
expect {
    \"administrator password\" {
        send \"$AdminTokenHash\r\"
        exp_continue
    }
    \"remember password\" {
        send \"n\r\"
        exp_continue
    }
    eof {
        exit 0
    }
    timeout {
        exit 1
    }
}
"

# pccsadmin get
[ -f platform_list.json ] && rm platform_list.json
URL="https://localhost:$HttpsPort/sgx/certification/v4/platforms"
expect -c "
set timeout 240
spawn pccsadmin get -u $URL
expect {
    \"administrator password\" {
        send \"$AdminTokenHash\r\"
        exp_continue
    }
    \"remember password\" {
        send \"n\r\"
        exp_continue
    }
    eof {
        exit 0
    }
    timeout {
        exit 1
    }
}
"
# Check if platform_list.json was generated by pccsadmin get
if [ ! -f platform_list.json ]; then
    echo "Pccsadmin get failed, platform_list.json was not generated."
    exit 1
fi

# pccsadmin refresh
URL="https://localhost:$HttpsPort/sgx/certification/v4/refresh"
expect -c "
set timeout 240
spawn pccsadmin refresh -u $URL
expect {
    \"administrator password\" { send \"$AdminTokenHash\r\"; exp_continue }
    \"y/n\" { send \"n\r\"; exp_continue }
    eof { exit 0 }
    timeout { exit 1 }
}"

# pccsadmin cache
expect -c "
set timeout 240
spawn pccsadmin cache -i platform_list.json -o ./my_cache
expect {
    -re \"ApiKey.*:\" {
        send \"\$env(PCCS_PRIMARY_API_KEY)\r\"
        exp_continue
    }
    -re \"remember.*y/n\" {
        send \"n\r\"
        exp_continue
    }
    eof {
        exit 0
    }
    timeout {
        exit 1
    }
}
"

# END Tests
